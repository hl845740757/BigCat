# Mongo原生Codec设计缺陷

Mongo的原生Codec有两个地方十分难用：

1. Codec和CodecRegistry
2. BsonWriter和BsonReader

当它俩结合起来的时候，不想说，太难受了....

## Codec和CodecRegistry

在使用MongoDB时，如果未使用ODM，我们通常通过实现Mongo原生的Codec实现自定义编解码；
这里存在一个问题，我们经常会遇见编码嵌套对象的情况，但encode和decode方法参数中无法获取到CodecRegistry。
这导致我们需要先持有嵌套对象的Codec，这是个超大的坑，因为导致了**循环依赖**！！！

Mongo为了解决这个问题，设计了Provider，ChildXXX和LazyXXX，恕我直言，净整些花里胡哨的没用的东西，这些新增的接口和类，并没有解决用户难受的问题，性能也不咋地，
看代码更是糊涂（绕来绕去）；而如果CodecRegistry是可以在encode和decode的时候获取的，那么这些问题压根儿不会发生。  
设计之丑陋，可见于此矣...

Mongo解决换个问题的最简单方式是在Context中提供获取CodecRegistry的方法，这样就可以避免用户持有其它的Codec类，还可以保持接口的兼容。
解除这个循环依赖后，用户的代码和库的代码都可以变得很干净易读，性能也容易得到保证。

PS：自认为我的Codec接口就挺好。

## BsonWriter和BsonReader

自实现Codec的时候，另一个让人用的很难受和不明所以的地方就是Writer和Reader了，存在以下问题：

1. 读写方法不对称，写Document/Array要名字，读的时候不要...我是用的很纳闷。
2. 由于数组的元素是没有名字的，，因此读写一个值的方法总有两个版本 -- 带name的不带name的，方法数量多也会增加学习成本和误用风险。

第二个问题导致用起来存在不便，但情有可原；但第一个问题我就认为是设计缺陷。  
在我设计的文档编解码接口中，读写数组和普通对象内元素使用相同的api，我用Null表达数组内元素的名字。

关于数组内元素的名字，可以有多种方案：
1. 数组下标的字符串 - 使用下标的字符串固然很直观，但开销是不必的（可以缓存一定数量的字符串）。
2. 外层数组对象的名字，这种方式也足够直观，但需要一直传递一个不必要的名字。
3. null，当使用者知道数组内元素没有名字的时候，使用null其实是安全的，也没太大的学习成本。